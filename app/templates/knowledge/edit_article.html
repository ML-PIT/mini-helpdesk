{% extends "base.html" %}

{% block title %}Artikel bearbeiten: {{ article.title }} - ML Gruppe Helpdesk{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-0">
            <i class="bi bi-pencil"></i> Artikel bearbeiten
        </h1>
        <p class="text-muted mb-0">{{ article.title }}</p>
    </div>
    <div>
        <a href="{{ url_for('knowledge.view_article', slug=article.slug) }}" class="btn btn-outline-primary">
            <i class="bi bi-eye"></i> Vorschau
        </a>
        <a href="{{ url_for('knowledge.manage_articles') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Zurück zur Verwaltung
        </a>
    </div>
</div>

<div class="row">
    <div class="col-md-9">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-file-text"></i> Artikel Details
                    </h5>
                    <div>
                        {% if article.is_published %}
                            <span class="badge bg-success">Veröffentlicht</span>
                        {% else %}
                            <span class="badge bg-warning">Entwurf</span>
                        {% endif %}
                        {% if article.is_featured %}
                            <span class="badge bg-warning text-dark">Featured</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="card-body">
                <form method="POST">
                    {{ form.hidden_tag() }}
                    
                    <div class="mb-3">
                        {{ form.title.label(class="form-label") }}
                        {{ form.title(class="form-control") }}
                        {% for error in form.title.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.summary.label(class="form-label") }}
                        {{ form.summary(class="form-control", rows="3") }}
                        {% for error in form.summary.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                    
                    <div class="mb-3">
                        {{ form.content.label(class="form-label") }}
                        {{ form.content(class="form-control", rows="15", id="articleContent") }}
                        {% for error in form.content.errors %}
                            <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            {{ form.category_id.label(class="form-label") }}
                            {{ form.category_id(class="form-select") }}
                            {% for error in form.category_id.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                        
                        <div class="col-md-6">
                            {{ form.tags.label(class="form-label") }}
                            {{ form.tags(class="form-control") }}
                            {% for error in form.tags.errors %}
                                <div class="text-danger small">{{ error }}</div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="form-check">
                                {{ form.is_public(class="form-check-input") }}
                                {{ form.is_public.label(class="form-check-label") }}
                                <div class="form-text">Für alle Besucher sichtbar</div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="form-check">
                                {{ form.is_featured(class="form-check-input") }}
                                {{ form.is_featured.label(class="form-check-label") }}
                                <div class="form-text">Als Featured-Artikel hervorheben</div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="is_published" name="is_published" {{ 'checked' if article.is_published else '' }}>
                                <label class="form-check-label" for="is_published">
                                    Veröffentlicht
                                </label>
                                <div class="form-text">Artikel ist live und sichtbar</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('knowledge.manage_articles') }}" class="btn btn-secondary me-md-2">Abbrechen</a>
                        <button type="submit" class="btn btn-outline-primary me-md-2" name="action" value="save">
                            <i class="bi bi-save"></i> Speichern
                        </button>
                        {% if not article.is_published %}
                        <button type="submit" class="btn btn-success" name="action" value="publish">
                            <i class="bi bi-check-circle"></i> Veröffentlichen
                        </button>
                        {% else %}
                        <button type="submit" class="btn btn-warning" name="action" value="unpublish">
                            <i class="bi bi-pause-circle"></i> Zurückziehen
                        </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <!-- Article Info -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-info-circle"></i> Artikel Info
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <strong>Autor:</strong><br>
                    <small>{{ article.author.full_name }}</small>
                </div>
                
                <div class="mb-2">
                    <strong>Erstellt:</strong><br>
                    <small>{{ article.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                </div>
                
                <div class="mb-2">
                    <strong>Zuletzt bearbeitet:</strong><br>
                    <small>{{ article.updated_at.strftime('%d.%m.%Y %H:%M') }}</small>
                </div>
                
                <div class="mb-2">
                    <strong>Aufrufe:</strong><br>
                    <small>{{ article.view_count }}</small>
                </div>
                
                <div class="mb-2">
                    <strong>URL-Slug:</strong><br>
                    <small class="font-monospace">{{ article.slug }}</small>
                </div>
                
                {% if article.tags %}
                <div>
                    <strong>Aktuelle Tags:</strong><br>
                    {% for tag in article.tags.split(',') %}
                        {% if tag.strip() %}
                            <span class="badge bg-light text-dark me-1">{{ tag.strip() }}</span>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Article Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-gear"></i> Aktionen
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('knowledge.view_article', slug=article.slug) }}" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-eye"></i> Artikel anzeigen
                    </a>
                    
                    <button type="button" class="btn btn-outline-info btn-sm" onclick="copyArticleUrl()">
                        <i class="bi bi-link"></i> Link kopieren
                    </button>
                    
                    <hr>
                    
                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="duplicateArticle({{ article.id }})">
                        <i class="bi bi-copy"></i> Artikel duplizieren
                    </button>
                    
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteArticle({{ article.id }}, '{{ article.title|e }}')">
                        <i class="bi bi-trash"></i> Artikel löschen
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Revision History -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-clock-history"></i> Verlauf
                </h5>
            </div>
            <div class="card-body">
                <p class="small text-muted">Artikel-Versionshistorie wird in einer zukünftigen Version verfügbar sein.</p>
                
                <div class="d-grid">
                    <button type="button" class="btn btn-outline-secondary btn-sm" disabled>
                        <i class="bi bi-history"></i> Versionen anzeigen
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function copyArticleUrl() {
    const url = "{{ url_for('knowledge.view_article', slug=article.slug, _external=True) }}";
    navigator.clipboard.writeText(url).then(() => {
        alert('Artikel-URL wurde in die Zwischenablage kopiert!');
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = url;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Artikel-URL wurde in die Zwischenablage kopiert!');
    });
}

function duplicateArticle(articleId) {
    if (confirm('Möchten Sie eine Kopie dieses Artikels erstellen?')) {
        // Placeholder for article duplication
        alert('Artikel duplizieren (ID: ' + articleId + ')\n\nDiese Funktion ist noch nicht implementiert.');
        
        // Here you would make an AJAX request to duplicate the article
        // Example:
        // fetch('/kb/article/' + articleId + '/duplicate', {
        //     method: 'POST',
        //     headers: {'X-CSRFToken': csrf_token}
        // }).then(() => location.reload());
    }
}

function deleteArticle(articleId, articleTitle) {
    if (confirm('Sind Sie sicher, dass Sie den Artikel "' + articleTitle + '" löschen möchten?\n\nDiese Aktion kann nicht rückgängig gemacht werden!')) {
        // Placeholder for article deletion
        alert('Artikel löschen: ' + articleTitle + ' (ID: ' + articleId + ')\n\nDiese Funktion ist noch nicht implementiert.');
        
        // Here you would make an AJAX request to delete the article
        // window.location.href = '/kb/manage';
    }
}

// Auto-save functionality
let autoSaveTimeout;
function scheduleAutoSave() {
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(() => {
        // Here you would implement auto-save functionality
        console.log('Auto-save triggered');
        
        // You could make an AJAX request to save the current state
        // saveArticleDraft();
    }, 30000); // Save every 30 seconds
}

document.getElementById('articleContent').addEventListener('input', scheduleAutoSave);
</script>
{% endblock %}
{% extends 'base.html' %}

{% block title %}Ticket eskalieren - {{ app_title }}{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        Ticket {{ ticket.ticket_number }} eskalieren
    </div>

    <div style="background: #fff3cd; padding: 15px; border-radius: 6px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
        <strong>Aktueller Status:</strong><br>
        <div style="margin-top: 10px;">
            <strong>Titel:</strong> {{ ticket.title }}<br>
            <strong>Aktueller Support Level:</strong>
            <span class="level-badge level-{{ ticket.support_level }}">
                {% if ticket.support_level == 'level_1' %}Level 1{% endif %}
                {% if ticket.support_level == 'level_2' %}Level 2{% endif %}
                {% if ticket.support_level == 'level_3' %}Level 3{% endif %}
            </span><br>
            {% if ticket.assigned_to %}
            <strong>Aktuell zugewiesen an:</strong> {{ ticket.assigned_to.full_name }}
            {% endif %}
        </div>
    </div>

    {% if agents %}
    <form method="post">
        {% csrf_token %}

        <div class="form-group">
            <label for="agent_id">An welchen Agent eskalieren?</label>
            <select name="agent_id" id="agent_id" class="form-control" required>
                <option value="">Bitte wählen...</option>
                {% for agent in agents %}
                <option value="{{ agent.id }}">
                    {{ agent.full_name }}
                    {% if agent.support_level %}
                        - Level {{ agent.support_level }}
                    {% endif %}
                    {% if agent.department %}
                        ({{ agent.department }})
                    {% endif %}
                </option>
                {% endfor %}
            </select>
            <small style="color: #868e96;">Wählen Sie einen Agent mit höherem Support Level.</small>
        </div>

        <div class="form-group">
            <label for="support_level">Neuer Support Level (optional)</label>
            <select name="support_level" id="support_level" class="form-control">
                <option value="">Unverändert lassen</option>
                {% for level_code, level_name in support_levels %}
                    {% if level_code == 'level_2' and current_user_level < 2 %}
                    <option value="{{ level_code }}">{{ level_name }}</option>
                    {% elif level_code == 'level_3' and current_user_level < 3 %}
                    <option value="{{ level_code }}">{{ level_name }}</option>
                    {% endif %}
                {% endfor %}
            </select>
            <small style="color: #868e96;">Sie können nur zu höheren Levels eskalieren.</small>
        </div>

        <div class="form-group">
            <label for="reason">Grund für die Eskalation</label>
            <textarea name="reason" id="reason" class="form-control" rows="4" placeholder="Beschreiben Sie, warum dieses Ticket eskaliert werden muss..."></textarea>
            <small style="color: #868e96;">Dieser Kommentar ist nur für das Support-Team sichtbar.</small>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 30px;">
            <button type="submit" class="btn btn-warning">Ticket eskalieren</button>
            <a href="{% url 'tickets:detail' ticket.pk %}" class="btn btn-secondary">Abbrechen</a>
        </div>
    </form>
    {% else %}
    <div style="background: #e9ecef; padding: 20px; border-radius: 6px; text-align: center;">
        <p style="color: #495057; margin-bottom: 15px;">
            <strong>Keine Agents verfügbar</strong><br>
            Es gibt derzeit keine Agents mit einem höheren Support Level, an die Sie eskalieren könnten.
        </p>
        <a href="{% url 'tickets:detail' ticket.pk %}" class="btn btn-secondary">Zurück zum Ticket</a>
    </div>
    {% endif %}
</div>

<div class="card">
    <h3 style="margin-bottom: 15px; font-size: 16px;">Was bedeutet Eskalation?</h3>
    <ul style="line-height: 1.8; color: #495057; padding-left: 20px;">
        <li><strong>Level 1:</strong> First Line Support - Einfache Anfragen und Standardprobleme</li>
        <li><strong>Level 2:</strong> Technical Support - Komplexere technische Probleme</li>
        <li><strong>Level 3:</strong> Expert Support - Sehr komplexe oder kritische Probleme</li>
    </ul>
    <p style="margin-top: 15px; color: #495057; line-height: 1.6;">
        Eskalieren Sie ein Ticket, wenn:
    </p>
    <ul style="line-height: 1.8; color: #495057; padding-left: 20px; margin-top: 10px;">
        <li>Das Problem außerhalb Ihres Kompetenzbereichs liegt</li>
        <li>Spezialwissen erforderlich ist</li>
        <li>Das Problem sehr dringend oder kritisch ist</li>
    </ul>
</div>
{% endblock %}
